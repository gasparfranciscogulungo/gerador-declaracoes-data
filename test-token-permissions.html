<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Token GitHub</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #fff; }
        h1 { color: #4CAF50; }
        .test { margin: 10px 0; padding: 10px; background: #2d2d2d; border-radius: 5px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
    </style>
    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
</head>
<body>
    <h1>üîç Diagn√≥stico Completo do Token GitHub</h1>
    <button onclick="runFullDiagnosis()">‚ñ∂Ô∏è Executar Diagn√≥stico Completo</button>
    <button onclick="clearResults()">üóëÔ∏è Limpar Resultados</button>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            results.innerHTML += `<div class="test" style="border-left: 4px solid ${colors[type]}">
                <span class="${type}">${message}</span>
            </div>`;
        }

        function logObject(title, obj) {
            results.innerHTML += `<div class="test">
                <strong class="info">${title}:</strong>
                <pre>${JSON.stringify(obj, null, 2)}</pre>
            </div>`;
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function runFullDiagnosis() {
            clearResults();
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            // Teste 1: Verificar token no localStorage
            log('<h2>üì¶ 1. Verifica√ß√£o do Token Local</h2>', 'info');
            const token = localStorage.getItem('pdfsigner_github_token');
            
            if (!token) {
                log('‚ùå Token n√£o encontrado no localStorage!', 'error');
                log('üí° Solu√ß√£o: Fa√ßa login em login.html', 'warning');
                return;
            }
            
            log(`‚úÖ Token encontrado: ${token.substring(0, 10)}...${token.substring(token.length - 4)}`, 'success');
            log(`üìè Tamanho do token: ${token.length} caracteres`, 'info');
            
            // Teste 2: Configurar GitHub API
            log('<h2>‚öôÔ∏è 2. Configura√ß√£o do GitHub API</h2>', 'info');
            githubAPI.setToken(token);
            githubAPI.configurar(CONFIG.github);
            
            logObject('Configura√ß√£o', {
                owner: githubAPI.owner,
                repo: githubAPI.repo,
                branch: githubAPI.branch,
                baseURL: githubAPI.baseURL
            });

            // Teste 3: Verificar usu√°rio autenticado
            log('<h2>üë§ 3. Teste de Autentica√ß√£o</h2>', 'info');
            try {
                const user = await githubAPI.getAuthenticatedUser();
                log(`‚úÖ Usu√°rio autenticado: ${user.login}`, 'success');
                logObject('Dados do usu√°rio', {
                    login: user.login,
                    id: user.id,
                    name: user.name,
                    email: user.email,
                    type: user.type
                });
            } catch (error) {
                log(`‚ùå Falha na autentica√ß√£o: ${error.message}`, 'error');
                log('üí° Token inv√°lido ou expirado. Gere um novo token.', 'warning');
                return;
            }

            // Teste 4: Verificar permiss√µes do token
            log('<h2>üîê 4. An√°lise de Permiss√µes do Token</h2>', 'info');
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const scopes = response.headers.get('X-OAuth-Scopes');
                const scopesArray = scopes ? scopes.split(', ') : [];
                
                log(`üìã Scopes detectados: ${scopes || 'Nenhum'}`, scopes ? 'info' : 'warning');
                
                // Verificar scopes necess√°rios
                const requiredScopes = ['repo', 'workflow'];
                const hasRepo = scopesArray.includes('repo') || scopesArray.includes('public_repo');
                const hasWorkflow = scopesArray.includes('workflow');
                
                if (hasRepo) {
                    log('‚úÖ Scope "repo" ou "public_repo" presente', 'success');
                } else {
                    log('‚ùå PROBLEMA: Scope "repo" ausente!', 'error');
                    log('üí° Este √© o problema principal. Token precisa do scope "repo".', 'warning');
                }
                
                if (hasWorkflow) {
                    log('‚úÖ Scope "workflow" presente', 'success');
                } else {
                    log('‚ö†Ô∏è Scope "workflow" ausente (opcional)', 'warning');
                }
                
                logObject('Todos os scopes', scopesArray);
                
            } catch (error) {
                log(`‚ùå Erro ao verificar scopes: ${error.message}`, 'error');
            }

            // Teste 5: Testar leitura do reposit√≥rio
            log('<h2>üìñ 5. Teste de Leitura do Reposit√≥rio</h2>', 'info');
            try {
                const repoInfo = await fetch(`https://api.github.com/repos/${githubAPI.owner}/${githubAPI.repo}`, {
                    headers: githubAPI.getHeaders()
                });
                
                if (repoInfo.ok) {
                    const repo = await repoInfo.json();
                    log(`‚úÖ Reposit√≥rio acess√≠vel: ${repo.full_name}`, 'success');
                    logObject('Info do reposit√≥rio', {
                        name: repo.name,
                        private: repo.private,
                        default_branch: repo.default_branch,
                        permissions: repo.permissions
                    });
                } else {
                    log(`‚ùå Erro ao acessar reposit√≥rio: ${repoInfo.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }

            // Teste 6: Testar escrita (criar arquivo de teste)
            log('<h2>‚úçÔ∏è 6. Teste de Escrita (Upload)</h2>', 'info');
            try {
                const testPath = `assets/test-diagnostic/${Date.now()}.txt`;
                const testContent = btoa('Test upload - ' + new Date().toISOString());
                
                log(`üì§ Tentando criar arquivo: ${testPath}`, 'info');
                
                const uploadResponse = await fetch(`https://api.github.com/repos/${githubAPI.owner}/${githubAPI.repo}/contents/${testPath}`, {
                    method: 'PUT',
                    headers: githubAPI.getHeaders(),
                    body: JSON.stringify({
                        message: 'Test diagnostic upload',
                        content: testContent,
                        branch: githubAPI.branch
                    })
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    log('‚úÖ SUCESSO! Upload funcionou!', 'success');
                    log(`üîó Arquivo criado: ${result.content.path}`, 'success');
                    log(`üåê URL: ${result.content.download_url}`, 'info');
                    
                    // Tentar deletar o arquivo de teste
                    try {
                        await fetch(`https://api.github.com/repos/${githubAPI.owner}/${githubAPI.repo}/contents/${testPath}`, {
                            method: 'DELETE',
                            headers: githubAPI.getHeaders(),
                            body: JSON.stringify({
                                message: 'Delete test file',
                                sha: result.content.sha,
                                branch: githubAPI.branch
                            })
                        });
                        log('üóëÔ∏è Arquivo de teste removido', 'info');
                    } catch (e) {
                        log('‚ö†Ô∏è N√£o foi poss√≠vel remover arquivo de teste', 'warning');
                    }
                } else {
                    const errorData = await uploadResponse.json();
                    log(`‚ùå PROBLEMA ENCONTRADO: ${uploadResponse.status}`, 'error');
                    logObject('Detalhes do erro', errorData);
                    
                    if (uploadResponse.status === 401) {
                        log('üö® Erro 401: Token sem permiss√µes de escrita!', 'error');
                        log('üí° Solu√ß√£o: Gere novo token com scope "repo"', 'warning');
                    } else if (uploadResponse.status === 403) {
                        log('üö® Erro 403: Acesso negado!', 'error');
                        log('üí° Verifique se o token pertence ao dono do reposit√≥rio', 'warning');
                    } else if (uploadResponse.status === 404) {
                        log('üö® Erro 404: Reposit√≥rio n√£o encontrado!', 'error');
                        log('üí° Verifique owner/repo no config.js', 'warning');
                    }
                }
            } catch (error) {
                log(`‚ùå Erro no teste de escrita: ${error.message}`, 'error');
            }

            // Teste 7: Resumo final
            log('<h2>üìä 7. Resumo e Recomenda√ß√µes</h2>', 'info');
            log('Se todos os testes passaram: ‚úÖ Sistema pronto para uso!', 'success');
            log('Se teste 6 falhou com 401: üîë Gere novo token com scope "repo"', 'warning');
            log('Se teste 6 falhou com 404: üìÇ Verifique owner/repo no config.js', 'warning');
            log('Se teste 6 falhou com 403: üë§ Token n√£o pertence ao dono do repo', 'warning');
        }
    </script>
</body>
</html>
