<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrigir UTF-8 nos Dados - Gerador de Declara√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="bi bi-tools mr-3 text-blue-600"></i>
                Corrigir Codifica√ß√£o UTF-8 nos Dados
            </h1>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                <p class="text-yellow-800">
                    <i class="bi bi-exclamation-triangle mr-2"></i>
                    Esta ferramenta vai reprocessar todos os dados JSON salvos no GitHub para corrigir problemas de codifica√ß√£o UTF-8.
                </p>
            </div>

            <div class="space-y-4" id="app">
                <!-- Status -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-2">Status da Corre√ß√£o</h3>
                    <div id="status" class="text-gray-600">Aguardando in√≠cio...</div>
                </div>

                <!-- Logs -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-2">Log de Opera√ß√µes</h3>
                    <div id="logs" class="text-sm font-mono space-y-1 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- Bot√£o -->
                <button onclick="corrigirDados()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition-colors">
                    <i class="bi bi-arrow-clockwise mr-2"></i>Iniciar Corre√ß√£o UTF-8
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-orange-600'
            };
            
            const time = new Date().toLocaleTimeString('pt-PT');
            const logLine = document.createElement('div');
            logLine.className = colors[type];
            logLine.textContent = `[${time}] ${message}`;
            logs.appendChild(logLine);
            logs.scrollTop = logs.scrollHeight;
        }

        function setStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function corrigirDados() {
            try {
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                addLog('üîß INICIANDO CORRE√á√ÉO UTF-8', 'info');
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                setStatus('Processando...');

                // Verificar configura√ß√£o da API
                if (!githubAPI.token || !githubAPI.owner || !githubAPI.repo) {
                    throw new Error('API GitHub n√£o est√° configurada corretamente');
                }

                addLog(`üë§ Usu√°rio: ${authManager.usuarioAtual.username}`, 'info');
                addLog(`üì¶ Repo: ${githubAPI.owner}/${githubAPI.repo}`, 'info');
                addLog('', 'info');

                // Lista de arquivos para corrigir
                const arquivos = [
                    'data/trabalhadores.json',
                    'data/empresas.json',
                    'data/users.json',
                    'data/modelos.json',
                    'data/contador.json',
                    'data/personalizacoes.json'
                ];

                let processados = 0;
                let erros = 0;

                for (const arquivo of arquivos) {
                    try {
                        addLog(`üìÇ Processando: ${arquivo}...`, 'info');

                        // Ler arquivo atual
                        addLog(`  ‚è≥ Lendo do GitHub...`, 'info');
                        const result = await githubAPI.lerJSON(arquivo);
                        
                        if (!result || !result.data) {
                            addLog(`  ‚ö†Ô∏è Arquivo n√£o existe ou est√° vazio`, 'warning');
                            continue;
                        }

                        addLog(`  ‚úì Lido com sucesso (SHA: ${result.sha.substring(0, 7)})`, 'success');
                        
                        // Verificar se tem caracteres problem√°ticos
                        const jsonString = JSON.stringify(result.data);
                        const temProblema = jsonString.includes('√É¬ß') || jsonString.includes('√É¬£') || jsonString.includes('√É');
                        
                        if (temProblema) {
                            addLog(`  üîç Detectados caracteres UTF-8 corrompidos`, 'warning');
                        } else {
                            addLog(`  ‚úì Codifica√ß√£o parece OK`, 'info');
                        }

                        // Salvar novamente (vai usar a codifica√ß√£o UTF-8 correta)
                        addLog(`  üíæ Salvando com UTF-8 correto...`, 'info');
                        await githubAPI.salvarJSON(
                            arquivo,
                            result.data,
                            `üîß Corrigir codifica√ß√£o UTF-8: ${arquivo}`,
                            result.sha
                        );

                        addLog(`  ‚úÖ Salvo com codifica√ß√£o UTF-8 correta`, 'success');
                        addLog('', 'info');
                        processados++;

                    } catch (error) {
                        addLog(`  ‚ùå ERRO: ${error.message}`, 'error');
                        console.error('Detalhes do erro:', error);
                        addLog('', 'info');
                        erros++;
                    }
                }

                addLog('', 'info');
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                addLog(`‚úÖ Corre√ß√£o conclu√≠da!`, 'success');
                addLog(`üìä Arquivos processados: ${processados}`, 'success');
                if (erros > 0) {
                    addLog(`‚ö†Ô∏è Erros encontrados: ${erros}`, 'warning');
                }
                addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
                
                setStatus(`Conclu√≠do! ${processados} arquivos corrigidos.`);

                alert(`‚úÖ Corre√ß√£o UTF-8 conclu√≠da!\n\n${processados} arquivos processados\n${erros} erros encontrados\n\nAtualize a p√°gina admin.html para ver os dados corrigidos.`);

            } catch (error) {
                addLog(`‚ùå ERRO FATAL: ${error.message}`, 'error');
                setStatus('Erro ao processar');
                alert(`‚ùå Erro: ${error.message}`);
            }
        }

        // Auto-login ao carregar
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                addLog('Verificando autentica√ß√£o...', 'info');
                
                // Verificar se tem token no localStorage
                let token = localStorage.getItem('github_token');
                let userData = localStorage.getItem('usuario_atual');
                
                // Se n√£o tiver no localStorage, usar token tempor√°rio
                if (!token || !userData) {
                    addLog('‚ö†Ô∏è Token n√£o encontrado no localStorage', 'warning');
                    addLog('üîë Usando token de emerg√™ncia...', 'info');
                    
                    // Token tempor√°rio fornecido pelo usu√°rio
                    token = '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';
                    
                    // Configurar API com token
                    githubAPI.setToken(token);
                    githubAPI.configurar(CONFIG);
                    
                    // Buscar dados do usu√°rio do GitHub
                    try {
                        const githubUser = await githubAPI.getAuthenticatedUser();
                        userData = {
                            username: githubUser.login,
                            email: githubUser.email || githubUser.login + '@github.com',
                            role: 'admin'
                        };
                        
                        // Salvar no localStorage para pr√≥xima vez
                        localStorage.setItem('github_token', token);
                        localStorage.setItem('usuario_atual', JSON.stringify(userData));
                        
                        addLog(`‚úÖ Usu√°rio GitHub: ${githubUser.login}`, 'success');
                    } catch (error) {
                        addLog(`‚ùå Erro ao buscar usu√°rio: ${error.message}`, 'error');
                        throw error;
                    }
                } else {
                    // Tem no localStorage
                    userData = JSON.parse(userData);
                    githubAPI.setToken(token);
                    githubAPI.configurar(CONFIG);
                }
                
                authManager.usuarioAtual = userData;
                
                addLog(`‚úÖ Autenticado como: ${userData.username}`, 'success');
                addLog(`üì¶ Reposit√≥rio: ${CONFIG.owner}/${CONFIG.repo}`, 'info');
                setStatus('Pronto para corrigir dados');
                
            } catch (error) {
                addLog(`‚ùå Erro ao verificar autentica√ß√£o: ${error.message}`, 'error');
                addLog('üí° Verifique se o token est√° correto e tem permiss√µes', 'warning');
                setStatus('Erro de autentica√ß√£o');
            }
        });
    </script>
</body>
</html>
