<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>üîÑ Force Reset - User Panel</title>
    <style>
        body {
            background: #1a202c;
            color: #fff;
            font-family: 'Monaco', 'Consolas', monospace;
            padding: 40px;
            line-height: 1.6;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #48bb78; margin-bottom: 30px; }
        button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #38a169; }
        .danger { background: #f56565; }
        .danger:hover { background: #e53e3e; }
        .log {
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log div { margin: 5px 0; }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #63b3ed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Force Reset - User Panel Debug</h1>
        
        <div>
            <button onclick="verificarToken()">üîç Verificar Token Atual</button>
            <button onclick="forcarToken()">üíâ For√ßar Token Correto</button>
            <button onclick="limparTudo()" class="danger">üóëÔ∏è Limpar TUDO</button>
            <button onclick="testarAPI()">üß™ Testar API</button>
            <button onclick="abrirUserPanel()">‚ñ∂Ô∏è Abrir User Panel</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        // Token USER atualizado
        const TOKEN_CORRETO = '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';
        const TOKEN_ADMIN = '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';
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('log').appendChild(div);
        }

        function verificarToken() {
            log('=== VERIFICANDO TOKENS ===', 'warning');
            
            const githubToken = localStorage.getItem('github_token');
            const token = localStorage.getItem('token');
            
            log(`github_token: ${githubToken ? githubToken.substring(0, 20) + '...' : 'N√ÉO EXISTE'}`, 'info');
            log(`token: ${token ? token.substring(0, 20) + '...' : 'N√ÉO EXISTE'}`, 'info');
            
            if (githubToken === TOKEN_CORRETO) {
                log('‚úÖ github_token est√° CORRETO', 'success');
            } else {
                log('‚ùå github_token est√° ERRADO!', 'error');
            }
            
            if (token === TOKEN_CORRETO) {
                log('‚úÖ token est√° CORRETO', 'success');
            } else {
                log('‚ùå token est√° ERRADO!', 'error');
            }
            
            // Verificar outras chaves
            log('', 'info');
            log('Outras chaves no localStorage:', 'info');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                log(`  - ${key}`, 'info');
            }
        }

        function forcarToken() {
            log('=== FOR√áANDO TOKEN CORRETO ===', 'warning');
            
            // Salvar em TODAS as poss√≠veis varia√ß√µes
            localStorage.setItem('github_token', TOKEN_CORRETO);
            localStorage.setItem('token', TOKEN_CORRETO);
            localStorage.setItem('githubToken', TOKEN_CORRETO);
            
            log('‚úÖ Token salvo em:', 'success');
            log('  - github_token', 'success');
            log('  - token', 'success');
            log('  - githubToken', 'success');
            
            verificarToken();
        }

        function limparTudo() {
            if (confirm('‚ö†Ô∏è Isso vai DELETAR TUDO do localStorage e sessionStorage. Continuar?')) {
                log('=== LIMPANDO TUDO ===', 'error');
                
                const before = localStorage.length;
                localStorage.clear();
                sessionStorage.clear();
                
                log(`‚úÖ ${before} itens removidos do localStorage`, 'success');
                log('‚úÖ sessionStorage limpo', 'success');
                log('üîÑ Recarregue a p√°gina e configure novamente', 'warning');
            }
        }

        async function testarAPI() {
            log('=== TESTANDO GITHUB API ===', 'warning');
            
            const token = localStorage.getItem('github_token') || localStorage.getItem('token');
            
            if (!token) {
                log('‚ùå Nenhum token encontrado!', 'error');
                return;
            }
            
            log(`üîë Usando token: ${token.substring(0, 20)}...`, 'info');
            
            try {
                // Testar autentica√ß√£o
                log('üß™ Testando autentica√ß√£o...', 'info');
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!userResponse.ok) {
                    log(`‚ùå Autentica√ß√£o falhou: ${userResponse.status}`, 'error');
                    return;
                }
                
                const user = await userResponse.json();
                log(`‚úÖ Autenticado como: ${user.login}`, 'success');
                
                // Testar acesso ao arquivo
                log('', 'info');
                log('üß™ Testando acesso a empresas.json...', 'info');
                const fileResponse = await fetch('https://api.github.com/repos/gasparfranciscogulungo/gerador-declaracoes-data/contents/data/empresas.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!fileResponse.ok) {
                    log(`‚ùå Acesso ao arquivo falhou: ${fileResponse.status}`, 'error');
                    const errorText = await fileResponse.text();
                    log(`Resposta: ${errorText}`, 'error');
                    return;
                }
                
                const fileData = await fileResponse.json();
                log(`‚úÖ Arquivo acessado com sucesso!`, 'success');
                log(`  - Tamanho: ${fileData.size} bytes`, 'success');
                log(`  - SHA: ${fileData.sha}`, 'success');
                
                // Decodificar e contar empresas
                const content = atob(fileData.content.replace(/\n/g, ''));
                const empresas = JSON.parse(content);
                log(`‚úÖ ${empresas.empresas.length} empresas encontradas!`, 'success');
                
                log('', 'info');
                log('üéâ TODOS OS TESTES PASSARAM!', 'success');
                log('üëâ Agora clique em "Abrir User Panel"', 'warning');
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function abrirUserPanel() {
            log('üöÄ Abrindo user-panel.html...', 'success');
            window.open('user-panel.html', '_blank');
        }

        // Auto-executar verifica√ß√£o ao carregar
        window.onload = () => {
            log('üîß Debug Tool Carregado', 'success');
            log('Clique nos bot√µes acima para diagnosticar', 'info');
            log('', 'info');
            verificarToken();
        };
    </script>
</body>
</html>
