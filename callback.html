<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Gerador de Declara√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen flex items-center justify-center">
    
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div id="status-container">
            
            <!-- Loading -->
            <div id="loading-state" class="text-center">
                <div class="inline-block bg-blue-600 rounded-full p-4 mb-4">
                    <i class="bi bi-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticando...</h1>
                <p class="text-gray-600 mb-6">Processando credenciais</p>
                <div class="spinner mx-auto mb-4"></div>
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 text-left">
                    <p class="text-sm text-blue-800" id="status-message">
                        <i class="bi bi-hourglass-split mr-2"></i>Verificando...
                    </p>
                </div>
            </div>

            <!-- Success -->
            <div id="success-state" class="text-center hidden">
                <div class="inline-block bg-green-600 rounded-full p-4 mb-4">
                    <i class="bi bi-check-circle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h1>
                <p class="text-gray-600 mb-6">Redirecionando...</p>
                <div class="bg-green-50 border-l-4 border-green-600 p-4">
                    <p class="text-sm text-green-800">
                        <i class="bi bi-person-check mr-2"></i>
                        Bem-vindo, <strong id="user-name">...</strong>!
                    </p>
                </div>
            </div>

            <!-- Error -->
            <div id="error-state" class="text-center hidden">
                <div class="inline-block bg-red-600 rounded-full p-4 mb-4">
                    <i class="bi bi-exclamation-triangle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Erro</h1>
                <p class="text-gray-600 mb-6">N√£o foi poss√≠vel completar</p>
                <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-6">
                    <p class="text-sm text-red-800" id="error-message">
                        <i class="bi bi-x-circle mr-2"></i>Erro desconhecido
                    </p>
                </div>
                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg inline-block transition-colors">
                    <i class="bi bi-arrow-left mr-2"></i>Voltar
                </a>
            </div>

        </div>
    </div>

    <!-- Modal Token -->
    <div id="tokenModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:1rem;padding:2rem;max-width:500px;width:90%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3);">
            <h3 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:#1f2937;">üîë Personal Access Token</h3>
            <p style="color:#6b7280;margin-bottom:1.5rem;font-size:0.875rem;">Cole seu token do GitHub:</p>
            <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:1rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.875rem;color:#1e40af;margin:0;">
                    <strong>Como gerar:</strong><br>
                    1. <a href="https://github.com/settings/tokens" target="_blank" style="text-decoration:underline;">github.com/settings/tokens</a><br>
                    2. Generate new token (classic)<br>
                    3. Marque: <strong>repo</strong> + <strong>user</strong><br>
                    4. Cole aqui
                </p>
            </div>
            <input type="text" id="tokenInput" placeholder="ghp_xxxx..." style="width:100%;padding:0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-family:monospace;font-size:0.875rem;margin-bottom:1rem;">
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button onclick="cancelarToken()" style="padding:0.5rem 1.5rem;background:#e5e7eb;color:#374151;border:none;border-radius:0.5rem;cursor:pointer;">Cancelar</button>
                <button onclick="confirmarToken()" style="padding:0.5rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:0.5rem;cursor:pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Senha -->
    <div id="passwordModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:1rem;padding:2rem;max-width:500px;width:90%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3);">
            <h3 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:#1f2937;">üîê Criar Senha</h3>
            <p style="color:#6b7280;margin-bottom:1.5rem;font-size:0.875rem;">
                <span id="modalUsername" style="font-weight:600;color:#1f2937;"></span>, crie sua senha:
            </p>
            <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:1rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.875rem;color:#92400e;margin:0;">
                    <strong>Requisitos:</strong><br>
                    ‚Ä¢ M√≠nimo 8 caracteres<br>
                    ‚Ä¢ Pelo menos 1 n√∫mero
                </p>
            </div>
            <div style="margin-bottom:1rem;">
                <label style="display:block;font-weight:500;color:#374151;margin-bottom:0.5rem;font-size:0.875rem;">
                    <i class="bi bi-lock mr-1"></i> Senha
                </label>
                <input type="password" id="newPassword" placeholder="Digite sua senha" style="width:100%;padding:0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-size:0.875rem;">
            </div>
            <div style="margin-bottom:1.5rem;">
                <label style="display:block;font-weight:500;color:#374151;margin-bottom:0.5rem;font-size:0.875rem;">
                    <i class="bi bi-lock-fill mr-1"></i> Confirmar
                </label>
                <input type="password" id="confirmPassword" placeholder="Digite novamente" style="width:100%;padding:0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-size:0.875rem;">
            </div>
            <div id="passwordError" style="display:none;background:#fee2e2;border-left:4px solid #ef4444;padding:0.75rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.875rem;color:#991b1b;margin:0;">
                    <i class="bi bi-exclamation-triangle mr-1"></i>
                    <span id="passwordErrorText"></span>
                </p>
            </div>
            <button id="confirmPasswordBtn" onclick="confirmarSenha()" style="width:100%;padding:0.75rem;background:#3b82f6;color:white;border:none;border-radius:0.5rem;cursor:pointer;font-weight:500;">
                <i class="bi bi-check-circle mr-1"></i>Criar Conta
            </button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/crypto-utils.js"></script>
    <script src="js/password-manager.js"></script>
    <script src="js/dark-mode.js"></script>
    
    <script>
let tokenResolve, passwordResolve, currentToken, currentProfile;

function mostrarModalToken() {
    document.getElementById('tokenModal').style.display = 'flex';
    document.getElementById('tokenInput').focus();
    return new Promise(resolve => tokenResolve = resolve);
}

function confirmarToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) { alert('‚ö†Ô∏è Cole o token!'); return; }
    document.getElementById('tokenModal').style.display = 'none';
    tokenResolve(token);
}

function cancelarToken() {
    document.getElementById('tokenModal').style.display = 'none';
    // Redirecionar para a p√°gina de login
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 100);
    tokenResolve(null);
}

function mostrarModalSenha(username) {
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('passwordModal').style.display = 'flex';
    document.getElementById('newPassword').focus();
    return new Promise(resolve => passwordResolve = resolve);
}

function mostrarErroSenha(msg) {
    document.getElementById('passwordErrorText').textContent = msg;
    document.getElementById('passwordError').style.display = 'block';
}

function ocultarErroSenha() {
    document.getElementById('passwordError').style.display = 'none';
}

async function confirmarSenha() {
    const senha = document.getElementById('newPassword').value;
    const confirmar = document.getElementById('confirmPassword').value;
    
    ocultarErroSenha();
    
    if (!senha || !confirmar) {
        mostrarErroSenha('Preencha todos os campos');
        return;
    }
    
    if (senha !== confirmar) {
        mostrarErroSenha('As senhas n√£o conferem');
        document.getElementById('confirmPassword').value = '';
        return;
    }
    
    const validacao = CryptoUtils.validarSenha(senha);
    if (!validacao.valida) {
        mostrarErroSenha(validacao.erros.join('. '));
        return;
    }
    
    const btn = document.getElementById('confirmPasswordBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i>Criando...';
    
    document.getElementById('passwordModal').style.display = 'none';
    passwordResolve(senha);
}

async function processarCallback() {
    const statusMsg = document.getElementById('status-message');
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) throw new Error(`GitHub OAuth error: ${error}`);

        let token, profile;

        if (!code) {
            // N√£o h√° c√≥digo OAuth, solicitar token manual
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando token...';
            
            token = await mostrarModalToken();
            if (!token) {
                throw new Error('Token n√£o fornecido. Opera√ß√£o cancelada.');
            }
            
            githubAPI.setToken(token);
        } else {
            // C√≥digo OAuth presente mas n√£o implementado ainda
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando token...';
            
            token = await mostrarModalToken();
            if (!token) {
                throw new Error('Token n√£o fornecido. Opera√ß√£o cancelada.');
            }
            
            githubAPI.setToken(token);
        }

        statusMsg.innerHTML = '<i class="bi bi-person mr-2"></i>Carregando perfil...';
        profile = await githubAPI.getAuthenticatedUser();
        
        if (!profile || !profile.login) throw new Error('Token inv√°lido');
        
        currentToken = token;
        currentProfile = profile;
        
        const recuperarUsername = sessionStorage.getItem('recuperar_senha_username');
        
        if (recuperarUsername && recuperarUsername === profile.login) {
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Nova senha...';
            sessionStorage.removeItem('recuperar_senha_username');
            
            const novaSenha = await mostrarModalSenha(profile.login);
            statusMsg.innerHTML = '<i class="bi bi-shield-check mr-2"></i>Salvando...';
            
            const result = await passwordManager.recuperarSenha(profile.login, novaSenha, token, profile);
            finalizarComSucesso(profile.login, result.isAdmin);
            
        } else {
            statusMsg.innerHTML = '<i class="bi bi-search mr-2"></i>Verificando...';
            const existe = await passwordManager.usuarioExiste(profile.login);
            
            if (existe) {
                throw new Error(`Conta j√° existe!\n\nUse o login com senha.\nEsqueceu? Clique em "Esqueci minha senha".`);
            }
            
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Crie sua senha...';
            const senha = await mostrarModalSenha(profile.login);
            
            statusMsg.innerHTML = '<i class="bi bi-shield-check mr-2"></i>Criando conta...';
            const result = await passwordManager.criarConta(profile.login, senha, token, profile);
            
            finalizarComSucesso(profile.login, result.isAdmin);
        }

    } catch (error) {
        console.error('‚ùå Erro:', error);
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('error-message').innerHTML = `<i class="bi bi-x-circle mr-2"></i>${error.message}`;
    }
}

function finalizarComSucesso(username, isAdmin) {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('success-state').classList.remove('hidden');
    document.getElementById('user-name').textContent = username;
    
    setTimeout(() => {
        window.location.href = isAdmin ? 'admin.html' : 'user.html';
    }, 2000);
}

window.addEventListener('load', processarCallback);

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('tokenInput')?.addEventListener('keypress', e => {
        if (e.key === 'Enter') confirmarToken();
    });
    document.getElementById('confirmPassword')?.addEventListener('keypress', e => {
        if (e.key === 'Enter') confirmarSenha();
    });
});
    </script>

</body>
</html>
