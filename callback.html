<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Gerador de Declarações</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen flex items-center justify-center">
    
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        
        <!-- Status Container -->
        <div id="status-container">
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center">
                <div class="inline-block bg-blue-600 rounded-full p-4 mb-4">
                    <i class="bi bi-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticando...</h1>
                <p class="text-gray-600 mb-6">Processando suas credenciais do GitHub</p>
                
                <div class="spinner mx-auto mb-4"></div>
                
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 text-left">
                    <p class="text-sm text-blue-800" id="status-message">
                        <i class="bi bi-hourglass-split mr-2"></i>
                        Verificando autenticação...
                    </p>
                </div>
            </div>

            <!-- Success State -->
            <div id="success-state" class="text-center hidden">
                <div class="inline-block bg-green-600 rounded-full p-4 mb-4">
                    <i class="bi bi-check-circle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticado com sucesso!</h1>
                <p class="text-gray-600 mb-6">Redirecionando para seu painel...</p>
                
                <div class="bg-green-50 border-l-4 border-green-600 p-4">
                    <p class="text-sm text-green-800">
                        <i class="bi bi-person-check mr-2"></i>
                        Bem-vindo(a), <strong id="user-name">...</strong>!
                    </p>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center hidden">
                <div class="inline-block bg-red-600 rounded-full p-4 mb-4">
                    <i class="bi bi-exclamation-triangle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Erro na autenticação</h1>
                <p class="text-gray-600 mb-6">Não foi possível completar o login</p>
                
                <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-6">
                    <p class="text-sm text-red-800" id="error-message">
                        <i class="bi bi-x-circle mr-2"></i>
                        Erro desconhecido
                    </p>
                </div>

                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg inline-block transition-colors">
                    <i class="bi bi-arrow-left mr-2"></i>Voltar ao Login
                </a>
            </div>

        </div>

    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/dark-mode.js"></script>

    <script>
        let tokenResolve;
        
        // Mostrar modal de token
        function mostrarModalToken() {
            document.getElementById('tokenModal').style.display = 'flex';
            document.getElementById('tokenInput').focus();
            
            return new Promise((resolve) => {
                tokenResolve = resolve;
            });
        }
        
        // Confirmar token
        function confirmarToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                alert('⚠️ Por favor, cole o token!');
                return;
            }
            document.getElementById('tokenModal').style.display = 'none';
            tokenResolve(token);
        }
        
        // Cancelar
        function cancelarToken() {
            document.getElementById('tokenModal').style.display = 'none';
            tokenResolve(null);
        }
        
        // Enter para confirmar
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('tokenInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') confirmarToken();
                });
            }
        });
        
        // Processar callback OAuth
        async function processarCallback() {
            const statusMsg = document.getElementById('status-message');
            
            try {
                // 1. Verificar se tem código na URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                // Verificar erro do GitHub
                if (error) {
                    throw new Error(`GitHub OAuth error: ${error}`);
                }

                if (!code) {
                    statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando Personal Access Token...';
                    
                    // Mostrar modal para colar token
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const token = await mostrarModalToken();

                    if (!token) {
                        throw new Error('Token não fornecido');
                    }

                    statusMsg.innerHTML = '<i class="bi bi-check2 mr-2"></i>Token recebido! Validando...';
                    
                    // Salvar e configurar
                    authManager.salvarToken(token);
                    githubAPI.setToken(token);
                    
                } else {
                    // OAuth real (futuro)
                    statusMsg.innerHTML = '<i class="bi bi-arrow-repeat mr-2"></i>Trocando código por token...';
                    const resultado = await authManager.processarCallback();
                }

                // 2. Obter dados do usuário
                statusMsg.innerHTML = '<i class="bi bi-person mr-2"></i>Carregando perfil...';
                const user = await githubAPI.getAuthenticatedUser();

                // 3. Sucesso!
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.login;

                // 4. Redirecionar baseado no tipo de usuário
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (authManager.isAdmin()) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'user.html';
                }

            } catch (error) {
                console.error('❌ Erro no callback:', error);
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').innerHTML = 
                    `<i class="bi bi-x-circle mr-2"></i>${error.message}`;
            }
        }

        // Executar quando carregar
        window.addEventListener('load', processarCallback);
    </script>

</body>
</html>
