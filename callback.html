<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Gerador de Declara√ß√µes</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen flex items-center justify-center">
    
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        
        <!-- Status Container -->
        <div id="status-container">
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center">
                <div class="inline-block bg-blue-600 rounded-full p-4 mb-4">
                    <i class="bi bi-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticando...</h1>
                <p class="text-gray-600 mb-6">Processando suas credenciais do GitHub</p>
                
                <div class="spinner mx-auto mb-4"></div>
                
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 text-left">
                    <p class="text-sm text-blue-800" id="status-message">
                        <i class="bi bi-hourglass-split mr-2"></i>
                        Verificando autentica√ß√£o...
                    </p>
                </div>
            </div>

            <!-- Success State -->
            <div id="success-state" class="text-center hidden">
                <div class="inline-block bg-green-600 rounded-full p-4 mb-4">
                    <i class="bi bi-check-circle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticado com sucesso!</h1>
                <p class="text-gray-600 mb-6">Redirecionando para seu painel...</p>
                
                <div class="bg-green-50 border-l-4 border-green-600 p-4">
                    <p class="text-sm text-green-800">
                        <i class="bi bi-person-check mr-2"></i>
                        Bem-vindo(a), <strong id="user-name">...</strong>!
                    </p>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center hidden">
                <div class="inline-block bg-red-600 rounded-full p-4 mb-4">
                    <i class="bi bi-exclamation-triangle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Erro na autentica√ß√£o</h1>
                <p class="text-gray-600 mb-6">N√£o foi poss√≠vel completar o login</p>
                
                <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-6">
                    <p class="text-sm text-red-800" id="error-message">
                        <i class="bi bi-x-circle mr-2"></i>
                        Erro desconhecido
                    </p>
                </div>

                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg inline-block transition-colors">
                    <i class="bi bi-arrow-left mr-2"></i>Voltar ao Login
                </a>
            </div>

        </div>

    </div>

    <!-- Modal para Personal Access Token -->
    <div id="tokenModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);">
            <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">
                üîë Personal Access Token
            </h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.875rem;">
                Cole seu Personal Access Token do GitHub abaixo:
            </p>
            
            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                <p style="font-size: 0.875rem; color: #1e40af; margin: 0;">
                    <strong>Como gerar:</strong><br>
                    1. Acesse: <a href="https://github.com/settings/tokens" target="_blank" style="text-decoration: underline;">github.com/settings/tokens</a><br>
                    2. Generate new token (classic)<br>
                    3. Selecione: <strong>repo</strong> + <strong>user</strong><br>
                    4. Copie e cole aqui
                </p>
            </div>

            <input 
                type="text" 
                id="tokenInput" 
                placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; margin-bottom: 1rem;"
            >

            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button onclick="cancelarToken()" style="padding: 0.5rem 1.5rem; background: #e5e7eb; color: #374151; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">
                    Cancelar
                </button>
                <button onclick="confirmarToken()" style="padding: 0.5rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/dark-mode.js"></script>

    <script>
        let tokenResolve;
        
        // Mostrar modal de token
        function mostrarModalToken() {
            document.getElementById('tokenModal').style.display = 'flex';
            document.getElementById('tokenInput').focus();
            
            return new Promise((resolve) => {
                tokenResolve = resolve;
            });
        }
        
        // Confirmar token
        function confirmarToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                alert('‚ö†Ô∏è Por favor, cole o token!');
                return;
            }
            document.getElementById('tokenModal').style.display = 'none';
            tokenResolve(token);
        }
        
        // Cancelar
        function cancelarToken() {
            document.getElementById('tokenModal').style.display = 'none';
            tokenResolve(null);
        }
        
        // Enter para confirmar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tokenInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmarToken();
            });
        });
        
        // Processar callback OAuth
        async function processarCallback() {
            const statusMsg = document.getElementById('status-message');
            
            try {
                // 1. Verificar se tem c√≥digo na URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');

                // Verificar erro do GitHub
                if (error) {
                    throw new Error(`GitHub OAuth error: ${error}`);
                }

                if (!code) {
                    statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando Personal Access Token...';
                    
                    // Mostrar modal para colar token
                    const token = await mostrarModalToken();

                    if (!token) {
                        throw new Error('Token n√£o fornecido');
                    }

                    statusMsg.innerHTML = '<i class="bi bi-check2 mr-2"></i>Token recebido! Validando...';
                    
                    // Salvar e configurar
                    authManager.salvarToken(token);
                    githubAPI.setToken(token);
                    
                } else {
                    // OAuth real (futuro)
                    statusMsg.innerHTML = '<i class="bi bi-arrow-repeat mr-2"></i>Trocando c√≥digo por token...';
                    const resultado = await authManager.processarCallback();
                }

                // 2. Obter dados do usu√°rio
                statusMsg.innerHTML = '<i class="bi bi-person mr-2"></i>Carregando perfil...';
                const user = await githubAPI.getAuthenticatedUser();

                // 3. Sucesso!
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.login;

                // 4. Redirecionar baseado no tipo de usu√°rio
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (authManager.isAdmin()) {
                    window.location.href = '/admin.html';
                } else {
                    window.location.href = '/user.html';
                }

            } catch (error) {
                console.error('‚ùå Erro no callback:', error);
                
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').innerHTML = 
                    `<i class="bi bi-x-circle mr-2"></i>${error.message}`;
            }
        }

        // Executar quando carregar
        window.addEventListener('load', processarCallback);
    </script>

</body>
</html>
