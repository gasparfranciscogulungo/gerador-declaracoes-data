<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Gerador de Declara√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen flex items-center justify-center">
    
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div id="status-container">
            
            <!-- Loading -->
            <div id="loading-state" class="text-center">
                <div class="inline-block bg-blue-600 rounded-full p-4 mb-4">
                    <i class="bi bi-shield-check text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Autenticando...</h1>
                <p class="text-gray-600 mb-6">Processando credenciais</p>
                <div class="spinner mx-auto mb-4"></div>
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 text-left">
                    <p class="text-sm text-blue-800" id="status-message">
                        <i class="bi bi-hourglass-split mr-2"></i>Verificando...
                    </p>
                </div>
            </div>

            <!-- Success -->
            <div id="success-state" class="text-center hidden">
                <div class="inline-block bg-green-600 rounded-full p-4 mb-4">
                    <i class="bi bi-check-circle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sucesso!</h1>
                <p class="text-gray-600 mb-6">Redirecionando...</p>
                <div class="bg-green-50 border-l-4 border-green-600 p-4">
                    <p class="text-sm text-green-800">
                        <i class="bi bi-person-check mr-2"></i>
                        Bem-vindo, <strong id="user-name">...</strong>!
                    </p>
                </div>
            </div>

            <!-- Error -->
            <div id="error-state" class="text-center hidden">
                <div class="inline-block bg-red-600 rounded-full p-4 mb-4">
                    <i class="bi bi-exclamation-triangle text-white text-4xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Erro</h1>
                <p class="text-gray-600 mb-6">N√£o foi poss√≠vel completar</p>
                <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-6">
                    <p class="text-sm text-red-800" id="error-message">
                        <i class="bi bi-x-circle mr-2"></i>Erro desconhecido
                    </p>
                </div>
                <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg inline-block transition-colors">
                    <i class="bi bi-arrow-left mr-2"></i>Voltar
                </a>
            </div>

        </div>
    </div>

    <!-- Modal Token -->
    <div id="tokenModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:1rem;padding:2rem;max-width:500px;width:90%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3);">
            <h3 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:#1f2937;">üîë Personal Access Token</h3>
            <p style="color:#6b7280;margin-bottom:1.5rem;font-size:0.875rem;">Cole seu token do GitHub:</p>
            <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:1rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.875rem;color:#1e40af;margin:0;">
                    <strong>Como gerar:</strong><br>
                    1. <a href="https://github.com/settings/tokens" target="_blank" style="text-decoration:underline;">github.com/settings/tokens</a><br>
                    2. Generate new token (classic)<br>
                    3. Marque: <strong>repo</strong> + <strong>user</strong><br>
                    4. Cole aqui
                </p>
            </div>
            <input type="text" id="tokenInput" placeholder="ghp_xxxx..." style="width:100%;padding:0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-family:monospace;font-size:0.875rem;margin-bottom:1rem;">
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button onclick="cancelarToken()" style="padding:0.5rem 1.5rem;background:#e5e7eb;color:#374151;border:none;border-radius:0.5rem;cursor:pointer;">Cancelar</button>
                <button onclick="confirmarToken()" style="padding:0.5rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:0.5rem;cursor:pointer;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Senha -->
    <div id="passwordModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:white;border-radius:1rem;padding:2rem;max-width:500px;width:90%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3);">
            <h3 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;color:#1f2937;">üîê Criar Senha</h3>
            <p style="color:#6b7280;margin-bottom:1.5rem;font-size:0.875rem;">
                <span id="modalUsername" style="font-weight:600;color:#1f2937;"></span>, crie sua senha:
            </p>
            
            <!-- Senha -->
            <div style="margin-bottom:1rem;">
                <label style="display:block;font-weight:500;color:#374151;margin-bottom:0.5rem;font-size:0.875rem;">
                    <i class="bi bi-lock mr-1"></i> Senha
                </label>
                <div style="position:relative;">
                    <input type="password" id="newPassword" placeholder="Digite sua senha" style="width:100%;padding:0.75rem 3rem 0.75rem 0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-size:0.875rem;">
                    <button type="button" onclick="toggleModalPassword('newPassword', 'toggleNew')" style="position:absolute;right:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#6b7280;">
                        <i id="toggleNew" class="bi bi-eye" style="font-size:1.125rem;"></i>
                    </button>
                </div>
            </div>

            <!-- Indicador de For√ßa -->
            <div id="passwordStrength" style="margin-bottom:1rem;display:none;">
                <div style="display:flex;gap:0.25rem;margin-bottom:0.5rem;">
                    <div id="bar1" style="height:4px;flex:1;background:#e5e7eb;border-radius:2px;transition:all 0.3s;"></div>
                    <div id="bar2" style="height:4px;flex:1;background:#e5e7eb;border-radius:2px;transition:all 0.3s;"></div>
                    <div id="bar3" style="height:4px;flex:1;background:#e5e7eb;border-radius:2px;transition:all 0.3s;"></div>
                    <div id="bar4" style="height:4px;flex:1;background:#e5e7eb;border-radius:2px;transition:all 0.3s;"></div>
                </div>
                <p id="strengthText" style="font-size:0.75rem;color:#6b7280;margin:0;"></p>
            </div>

            <!-- Requisitos -->
            <div style="background:#f9fafb;border:1px solid #e5e7eb;padding:0.75rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.75rem;font-weight:600;color:#374151;margin:0 0 0.5rem 0;">Requisitos:</p>
                <div style="display:flex;flex-direction:column;gap:0.25rem;">
                    <div id="req-length" style="font-size:0.75rem;color:#6b7280;">
                        <i class="bi bi-circle" style="font-size:0.5rem;margin-right:0.5rem;"></i>M√≠nimo 8 caracteres
                    </div>
                    <div id="req-number" style="font-size:0.75rem;color:#6b7280;">
                        <i class="bi bi-circle" style="font-size:0.5rem;margin-right:0.5rem;"></i>Pelo menos 1 n√∫mero
                    </div>
                </div>
            </div>

            <!-- Confirmar Senha -->
            <div style="margin-bottom:1rem;">
                <label style="display:block;font-weight:500;color:#374151;margin-bottom:0.5rem;font-size:0.875rem;">
                    <i class="bi bi-lock-fill mr-1"></i> Confirmar Senha
                </label>
                <div style="position:relative;">
                    <input type="password" id="confirmPassword" placeholder="Digite novamente" style="width:100%;padding:0.75rem 3rem 0.75rem 0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;font-size:0.875rem;">
                    <button type="button" onclick="toggleModalPassword('confirmPassword', 'toggleConfirm')" style="position:absolute;right:0.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#6b7280;">
                        <i id="toggleConfirm" class="bi bi-eye" style="font-size:1.125rem;"></i>
                    </button>
                </div>
            </div>

            <!-- Match Indicator -->
            <div id="passwordMatch" style="display:none;padding:0.5rem;margin-bottom:1rem;border-radius:0.5rem;font-size:0.75rem;">
                <i class="bi mr-1"></i><span id="matchText"></span>
            </div>

            <!-- Erro -->
            <div id="passwordError" style="display:none;background:#fee2e2;border-left:4px solid #ef4444;padding:0.75rem;margin-bottom:1rem;border-radius:0.5rem;">
                <p style="font-size:0.875rem;color:#991b1b;margin:0;">
                    <i class="bi bi-exclamation-triangle mr-1"></i>
                    <span id="passwordErrorText"></span>
                </p>
            </div>

            <!-- Bot√£o -->
            <button id="confirmPasswordBtn" onclick="confirmarSenha()" style="width:100%;padding:0.75rem;background:#3b82f6;color:white;border:none;border-radius:0.5rem;cursor:pointer;font-weight:500;transition:all 0.3s;" disabled>
                <i class="bi bi-check-circle mr-1"></i>Criar Conta
            </button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/github-api.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/crypto-utils.js"></script>
    <script src="js/password-manager.js"></script>
    <script src="js/dark-mode.js"></script>
    
    <script>
let tokenResolve, passwordResolve, currentToken, currentProfile;

function mostrarModalToken() {
    document.getElementById('tokenModal').style.display = 'flex';
    document.getElementById('tokenInput').focus();
    return new Promise(resolve => tokenResolve = resolve);
}

function confirmarToken() {
    const token = document.getElementById('tokenInput').value.trim();
    if (!token) { alert('‚ö†Ô∏è Cole o token!'); return; }
    document.getElementById('tokenModal').style.display = 'none';
    tokenResolve(token);
}

function cancelarToken() {
    document.getElementById('tokenModal').style.display = 'none';
    // Redirecionar para a p√°gina de login
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 100);
    tokenResolve(null);
}

function mostrarModalSenha(username) {
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('passwordModal').style.display = 'flex';
    document.getElementById('newPassword').focus();
    
    // Adicionar listeners de valida√ß√£o em tempo real
    setupPasswordValidation();
    
    return new Promise(resolve => passwordResolve = resolve);
}

// ========== TOGGLE SENHA ==========
function toggleModalPassword(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// ========== VALIDA√á√ÉO DIN√ÇMICA ==========
function setupPasswordValidation() {
    const newPass = document.getElementById('newPassword');
    const confirmPass = document.getElementById('confirmPassword');
    const btn = document.getElementById('confirmPasswordBtn');
    
    // Limpar campos
    newPass.value = '';
    confirmPass.value = '';
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.style.cursor = 'not-allowed';
    
    // Validar ao digitar na senha
    newPass.addEventListener('input', () => {
        const senha = newPass.value;
        
        // Mostrar indicadores
        document.getElementById('passwordStrength').style.display = 'block';
        
        // Verificar requisitos
        const hasLength = senha.length >= 8;
        const hasNumber = /\d/.test(senha);
        
        // Atualizar requisitos visualmente
        updateRequirement('req-length', hasLength);
        updateRequirement('req-number', hasNumber);
        
        // Calcular for√ßa
        let strength = 0;
        if (senha.length >= 8) strength++;
        if (senha.length >= 12) strength++;
        if (/\d/.test(senha)) strength++;
        if (/[a-z]/.test(senha) && /[A-Z]/.test(senha)) strength++;
        if (/[!@#$%^&*(),.?":{}|<>]/.test(senha)) strength++;
        
        updateStrengthBar(Math.min(strength, 4));
        
        // Verificar match
        checkPasswordMatch();
    });
    
    // Validar ao digitar na confirma√ß√£o
    confirmPass.addEventListener('input', checkPasswordMatch);
}

function updateRequirement(id, met) {
    const el = document.getElementById(id);
    const icon = el.querySelector('i');
    
    if (met) {
        el.style.color = '#10b981';
        icon.classList.remove('bi-circle');
        icon.classList.add('bi-check-circle-fill');
    } else {
        el.style.color = '#6b7280';
        icon.classList.remove('bi-check-circle-fill');
        icon.classList.add('bi-circle');
    }
}

function updateStrengthBar(level) {
    const colors = ['#ef4444', '#f59e0b', '#eab308', '#10b981'];
    const texts = ['Fraca', 'Razo√°vel', 'Boa', 'Forte'];
    const textColors = ['#991b1b', '#92400e', '#854d0e', '#065f46'];
    
    // Resetar barras
    for (let i = 1; i <= 4; i++) {
        const bar = document.getElementById(`bar${i}`);
        if (i <= level) {
            bar.style.background = colors[level - 1];
        } else {
            bar.style.background = '#e5e7eb';
        }
    }
    
    // Atualizar texto
    const strengthText = document.getElementById('strengthText');
    if (level > 0) {
        strengthText.textContent = `For√ßa: ${texts[level - 1]}`;
        strengthText.style.color = textColors[level - 1];
        strengthText.style.fontWeight = '600';
    } else {
        strengthText.textContent = '';
    }
}

function checkPasswordMatch() {
    const senha = document.getElementById('newPassword').value;
    const confirmar = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('passwordMatch');
    const matchText = document.getElementById('matchText');
    const matchIcon = matchDiv.querySelector('i');
    const btn = document.getElementById('confirmPasswordBtn');
    
    ocultarErroSenha();
    
    if (!confirmar) {
        matchDiv.style.display = 'none';
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        return;
    }
    
    const hasLength = senha.length >= 8;
    const hasNumber = /\d/.test(senha);
    const isValid = hasLength && hasNumber;
    const isMatch = senha === confirmar;
    
    matchDiv.style.display = 'block';
    
    if (isMatch && isValid) {
        matchDiv.style.background = '#d1fae5';
        matchDiv.style.borderLeft = '4px solid #10b981';
        matchDiv.style.color = '#065f46';
        matchIcon.className = 'bi bi-check-circle-fill mr-1';
        matchText.textContent = 'Senhas conferem!';
        
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.style.background = '#10b981';
    } else if (isMatch && !isValid) {
        matchDiv.style.background = '#fef3c7';
        matchDiv.style.borderLeft = '4px solid #f59e0b';
        matchDiv.style.color = '#92400e';
        matchIcon.className = 'bi bi-exclamation-triangle-fill mr-1';
        matchText.textContent = 'Senha n√£o atende aos requisitos';
        
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    } else {
        matchDiv.style.background = '#fee2e2';
        matchDiv.style.borderLeft = '4px solid #ef4444';
        matchDiv.style.color = '#991b1b';
        matchIcon.className = 'bi bi-x-circle-fill mr-1';
        matchText.textContent = 'Senhas n√£o conferem';
        
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    }
}

function mostrarErroSenha(msg) {
    document.getElementById('passwordErrorText').textContent = msg;
    document.getElementById('passwordError').style.display = 'block';
}

function ocultarErroSenha() {
    document.getElementById('passwordError').style.display = 'none';
}

async function confirmarSenha() {
    const senha = document.getElementById('newPassword').value;
    const confirmar = document.getElementById('confirmPassword').value;
    const btn = document.getElementById('confirmPasswordBtn');
    
    ocultarErroSenha();
    
    if (!senha || !confirmar) {
        mostrarErroSenha('Preencha todos os campos');
        return;
    }
    
    if (senha !== confirmar) {
        mostrarErroSenha('As senhas n√£o conferem');
        return;
    }
    
    const validacao = CryptoUtils.validarSenha(senha);
    if (!validacao.valida) {
        mostrarErroSenha(validacao.erros.join('. '));
        return;
    }
    
    btn.disabled = true;
    btn.style.opacity = '0.5';
    btn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i>Criando...';
    
    try {
        document.getElementById('passwordModal').style.display = 'none';
        passwordResolve(senha);
    } catch (error) {
        mostrarErroSenha('Erro ao processar senha');
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.innerHTML = '<i class="bi bi-check-circle mr-1"></i>Criar Conta';
    }
}

async function processarCallback() {
    const statusMsg = document.getElementById('status-message');
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) throw new Error(`GitHub OAuth error: ${error}`);

        let token, profile;

        if (!code) {
            // N√£o h√° c√≥digo OAuth, solicitar token manual
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando token...';
            
            token = await mostrarModalToken();
            if (!token) {
                throw new Error('Token n√£o fornecido. Opera√ß√£o cancelada.');
            }
            
            githubAPI.setToken(token);
        } else {
            // C√≥digo OAuth presente mas n√£o implementado ainda
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Aguardando token...';
            
            token = await mostrarModalToken();
            if (!token) {
                throw new Error('Token n√£o fornecido. Opera√ß√£o cancelada.');
            }
            
            githubAPI.setToken(token);
        }

        statusMsg.innerHTML = '<i class="bi bi-person mr-2"></i>Carregando perfil...';
        profile = await githubAPI.getAuthenticatedUser();
        
        if (!profile || !profile.login) throw new Error('Token inv√°lido');
        
        currentToken = token;
        currentProfile = profile;
        
        const recuperarUsername = sessionStorage.getItem('recuperar_senha_username');
        
        if (recuperarUsername && recuperarUsername === profile.login) {
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Nova senha...';
            sessionStorage.removeItem('recuperar_senha_username');
            
            const novaSenha = await mostrarModalSenha(profile.login);
            statusMsg.innerHTML = '<i class="bi bi-shield-check mr-2"></i>Salvando...';
            
            const result = await passwordManager.recuperarSenha(profile.login, novaSenha, token, profile);
            finalizarComSucesso(profile.login, result.isAdmin);
            
        } else {
            statusMsg.innerHTML = '<i class="bi bi-search mr-2"></i>Verificando...';
            const existe = await passwordManager.usuarioExiste(profile.login);
            
            if (existe) {
                throw new Error(`Conta j√° existe!\n\nUse o login com senha.\nEsqueceu? Clique em "Esqueci minha senha".`);
            }
            
            statusMsg.innerHTML = '<i class="bi bi-key mr-2"></i>Crie sua senha...';
            const senha = await mostrarModalSenha(profile.login);
            
            statusMsg.innerHTML = '<i class="bi bi-shield-check mr-2"></i>Criando conta...';
            const result = await passwordManager.criarConta(profile.login, senha, token, profile);
            
            finalizarComSucesso(profile.login, result.isAdmin);
        }

    } catch (error) {
        console.error('‚ùå Erro:', error);
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('error-message').innerHTML = `<i class="bi bi-x-circle mr-2"></i>${error.message}`;
    }
}

function finalizarComSucesso(username, isAdmin) {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('success-state').classList.remove('hidden');
    document.getElementById('user-name').textContent = username;
    
    setTimeout(() => {
        // Determinar p√°gina de destino
        const targetPage = isAdmin ? 'admin.html' : 'user.html';
        
        // Construir URL completa
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        const targetUrl = window.location.origin + basePath + targetPage;
        
        console.log('üîÑ Redirecionando...');
        console.log('   Usu√°rio:', username);
        console.log('   Admin:', isAdmin);
        console.log('   Destino:', targetUrl);
        
        // Redirecionar
        window.location.replace(targetUrl);
    }, 2500);
}

window.addEventListener('load', processarCallback);

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('tokenInput')?.addEventListener('keypress', e => {
        if (e.key === 'Enter') confirmarToken();
    });
    document.getElementById('confirmPassword')?.addEventListener('keypress', e => {
        if (e.key === 'Enter') confirmarSenha();
    });
});
    </script>

</body>
</html>
